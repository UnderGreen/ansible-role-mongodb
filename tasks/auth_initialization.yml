---
- name: Create MongoDB Users
  block:
    - name: Use different mongod.conf for auth initialization
      template:
        src: mongod_init.conf.j2
        dest: /etc/mongod.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - mongodb restart
        - wait when mongodb is started on localhost

    - name: Flush all handlers at this point
      meta: flush_handlers

    - name: create administrative user "{{ mongodb_root_name }}"
      mongodb_user:
        database: admin
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        update_password: "{{ mongodb_user_update_password }}"
        roles: "{{ item.roles }}"
        login_port: "{{ mongodb_net_port }}"
      with_items:
        - {
          name: "{{ mongodb_root_name }}",
          password: "{{ mongodb_root_password }}",
          roles: "root"
          }
      no_log: true

    - name: create additional administrative user "{{ mongodb_admin_name }}"
      mongodb_user:
        database: admin
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        update_password: "{{ mongodb_user_update_password }}"
        roles: "{{ item.roles }}"
        login_port: "{{ mongodb_net_port }}"
      with_items:
        - {
          name: "{{ mongodb_admin_name }}",
          password: "{{ mongodb_admin_password }}",
          roles: "userAdminAnyDatabase"
          }
      no_log: true
      when:
        - mongodb_admin_name is defined
        - mongodb_admin_password is defined
        - mongodb_admin_name | length > 0
        - mongodb_admin_password | length > 0

    - name: create backup user "{{ mongodb_backup_name }}"
      mongodb_user:
        database: admin
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        update_password: "{{ mongodb_user_update_password }}"
        roles: "{{ item.roles }}"
        login_port: "{{ mongodb_net_port }}"
      with_items:
        - {
          name: "{{ mongodb_backup_name }}",
          password: "{{ mongodb_backup_password }}",
          roles: "backup,clusterMonitor"
          }
      no_log: true

  always:
    - name: Move back mongod.conf
      template:
        src: mongod.conf.j2
        dest: /etc/mongod.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - mongodb restart
        - wait when mongodb is started

    - name: Flush all handlers at this point
      meta: flush_handlers
      
  become: true
  ignore_errors: false
  