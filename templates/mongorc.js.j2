function authRequired() {
  try {
    if (db.serverCmdLineOpts().code == 13) {
      return true;
    }
    return false;
  }
  catch (err) {
    return false;
  }
}

if (authRequired()) {
  try {
{% if mongodb_replication_replset -%}
    rs.slaveOk()
{% endif %}
    var prev_db = db
    db = db.getSiblingDB('admin')
    db.auth( '{{ mongodb_user_admin_name }}', '{{ mongodb_user_admin_password }}')
    db = db.getSiblingDB(prev_db)
  }
  catch (err) {
    abort('Unknown error')
  }
}